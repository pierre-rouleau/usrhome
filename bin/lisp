#!/bin/sh
# SH FILE: lisp
#
# Purpose   : Run the Common Lisp REPL selected for this shell.
# Created   : Tuesday, February 10 2026.
# Author    : Pierre Rouleau <prouleau001@gmail.com>
# Time-stamp: <2026-02-11 08:09:26 EST, updated by Pierre Rouleau>
# ----------------------------------------------------------------------------

# Module Description
# ------------------
#
# Run the Lisp program selected by the USRHOME_PGMFOR_LISP environment
# variable.  The environment variable should have been set by one of the
# envfor-lisp-with-xyz script for lisp.  Normally these are invoked via the
# corresponding use-lisp-with-xyz alias.
#
# Also note that rlwrap is used around the call to ensure that we can edit
# at the lisp prompt properly using Emacs commands and cursors both from the
# shell but also when it is running inside Emacs.
#

# ----------------------------------------------------------------------------
# Dependencies
# ------------
#
# See dependencies of:
# - $USRHOME_DIR/ibin/envfor-lisp-with-clisp
# - $USRHOME_DIR/ibin/envfor-lisp-with-sbcl


# ----------------------------------------------------------------------------
# Code
# ----
#

pgm_name="$(basename "$0")"

print_usage()
{
    printf -- "
%s:  Run Common Lisp REPL that has been previously selected by one of
       the use-lisp-with-xyz command (where xyz is the REPL program name).
       The following setup commands are supported:
       - use-lisp-with-clasp : to use Clasp
       - use-lisp-with-clisp : to use GNU CLisp
       - use-lisp-with-sbcl  : to use SBCL

 Usage:   %s [OPTIONS]

  • OPTIONS:  -h     : print this help.
  • OPTIONS:  --help : print selected REPL options.

" "$pgm_name" "$pgm_name"
}

# Check validity of arguments
if [ -z "$USRHOME_PGMFOR_LISP" ]; then
    printf -- "\
Please first select a Lisp implementation by using one the following commands:
  - use-lisp-with-clasp : to use Clasp
  - use-lisp-with-clisp : to use GNU CLisp
  - use-lisp-with-sbcl  : to use SBCL
Then try again!\n"
    exit  1
else
    if [ "$1" = "-h" ]; then
        print_usage
        exit 0
    elif [ "$1" = "--help" ]; then
        if [ -z "$USRHOME_PGMFOR_LISP" ]; then
            print_usage
            exit 0
        else
            "$USRHOME_PGMFOR_LISP" --help
            exit 0
        fi
    fi
    case "$USRHOME_PGMFOR_LISP" in
        */sbcl | */clasp)
            if which rlwrap > /dev/null; then
                rlwrap "$USRHOME_PGMFOR_LISP" "$@"
            else
                "$USRHOME_PGMFOR_LISP" "$@"
            fi
            ;;

        */clisp)
            "$USRHOME_PGMFOR_LISP" "$@"
            ;;
        *)
            printf -- "*** ERROR: unsupported value of USRHOME_PGMFOR_LISP: %s\n" "$USRHOME_PGMFOR_LISP"
            exit 1
            ;;
        esac
fi

# -----------------------------------------------------------------------------
