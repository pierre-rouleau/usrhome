#!/bin/sh
# SH FILE: tail-audit4avc
#
# Purpose   : Tail the /var/audit/log with some reformatting.
# Created   : Wednesday, October 30 2024.
# Author    : Pierre Rouleau <prouleau001@gmail.com>
# Time-stamp: <2024-11-03 18:09:12 EST, updated by Pierre Rouleau>
# ----------------------------------------------------------------------------
# Module Description
# ------------------
#
# Print logged SELinux AVC and SYSCALL events as they occur.
# Each line show a count, the current date and time in readable format,
# the syscall name (instead of number) and the full logged line.
#
# The beginning of each line looks like the following (including the # character):
#
#   1 type=AVC     msg=audit(2024-11-01 07:55:02.285:3021)): avc:  denied  { read } for
#   2 type=SYSCALL msg=audit(2024-11-01 07:55:02.285:3021)): arch=c000003e syscall=stat success=yes exit=0

# ----------------------------------------------------------------------------
# Dependencies
# ------------
#
# tail, read, grep, GNU awk, GNU sed, cut, rev, date, printf

# ----------------------------------------------------------------------------
# Code
# ----
#
# Early version.  Later might provide more reformatting.
#
# Filter the log, looking for AVC and SYSCALL events.
# Print the item number, line up mag=audit, reformat date, replace syscall number by name.
# This code would be better written in some other language, Perl perhaps.
#
# The reformatting is done by au-format.
#
count=0
tail -f /var/log/audit/audit.log | grep 'type=\(AVC\|SYSCALL\)' | \
    while read -r LINE; do \
        count=$(( count + 1 )); \
        LINE="$(echo "$LINE" | "$USRHOME_DIR/bin/linux/au-format" )"; \
        printf -- "#%4d %s\n" "$count" "$LINE"; \
    done

# ----------------------------------------------------------------------------
# Local Variables:
# sh-shell: /bin/sh
# End:
